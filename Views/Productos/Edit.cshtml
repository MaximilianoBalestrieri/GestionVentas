@model GestionVentas.Models.Productos


<div class="container mt-5 d-flex justify-content-center">

    <div class="card shadow-sm border-0 w-100" style="max-width: 800px;">
        <div class="card-header bg-warning text-white">
            <h4 class="mb-0">‚úèÔ∏è Editar producto</h4>
        </div>
        <div class="card-body">
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            @using (Html.BeginForm("Edit", "Productos", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.IdProducto)
                @Html.HiddenFor(model => model.Imagen)

                <div class="row g-3">
                    <div class="col-md-4">
                        @Html.LabelFor(m => m.Codigo)
                        @Html.TextBoxFor(m => m.Codigo, new { @class = "form-control", required = "required" })
                    </div>

                    <div class="col-md-4">
                        @Html.LabelFor(m => m.Nombre)
                        @Html.TextBoxFor(m => m.Nombre, new { @class = "form-control", required = "required" })
                    </div>

                    <div class="col-md-4">
                        @Html.LabelFor(m => m.Categoria, "Marca")
                        @Html.TextBoxFor(m => m.Categoria, new { @class = "form-control" })
                    </div>

                    <div class="col-md-12">
                        @Html.LabelFor(m => m.Descripcion)
                        @Html.TextAreaFor(m => m.Descripcion, new { @class = "form-control", rows = "3" })
                    </div>

                    <div class="col-md-4">
                        @Html.LabelFor(m => m.PrecioCosto)
                        <input type="text" id="PrecioCostoVisible" class="form-control"
                            value="@Model.PrecioCosto.ToString("N2")" />
                        @Html.HiddenFor(m => m.PrecioCosto, new { id = "PrecioCostoReal" })
                    </div>

                    <div class="col-md-4">
                        @Html.LabelFor(m => m.RecargoPorcentaje)
                        @Html.TextBoxFor(m => m.RecargoPorcentaje, new { @class = "form-control", type = "number", id =
                        "RecargoPorcentaje" })
                </div>

                <div class="col-md-4">
                    @Html.LabelFor(m => m.PrecioVenta)
                    <input type="text" id="PrecioVentaVisible" class="form-control"
                        value="@Model.PrecioVenta.ToString("N2")" readonly />
                    @Html.HiddenFor(m => m.PrecioVenta, new { id = "PrecioVentaReal" })
                </div>

                <div class="col-md-4">
                    @Html.LabelFor(m => m.StockActual)
                    @Html.TextBoxFor(m => m.StockActual, new { @class = "form-control", type = "number" })
                </div>

                <div class="col-md-4">
                    @Html.LabelFor(m => m.StockMinimo)
                    @Html.TextBoxFor(m => m.StockMinimo, new { @class = "form-control", type = "number" })
                </div>

                <div class="col-md-4">
                    @Html.LabelFor(m => m.NombreProveedor, "Proveedor")
                    @Html.DropDownListFor(m => m.NombreProveedor, Model.Proveedores, new { @class = "form-control",
                                        required = "required" })

                </div>

                <!-- Imagen y Vista Previa -->
                <div class="col-md-6">
                    <label>Imagen</label>
                    <input type="file" name="imagen" class="form-control" accept="image/*"
                        onchange="mostrarVistaPrevia(this)" />
                </div>

                <div class="col-md-6 text-center">
                    <label>Vista previa:</label><br />
                    <img id="imgPreview" src="@Url.Content(Model?.Imagen ?? "~/imagenes/productos/no-disponible.png")"
                        class="img-thumbnail mt-2" style="max-height: 120px;" />
                </div>

                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-warning">üíæ Guardar cambios</button>
                    <a href="@Url.Action("Index", "Productos")" class="btn btn-secondary">‚Ü©Ô∏è Cancelar</a>
                </div>
            </div>
                        }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const costoVis = document.getElementById("PrecioCostoVisible");
        const costoReal = document.getElementById("PrecioCostoReal");
        const recargoInput = document.getElementById("RecargoPorcentaje");
        const ventaVis = document.getElementById("PrecioVentaVisible");
        const ventaReal = document.getElementById("PrecioVentaReal");

        function calcular() {
            // Limpiamos el valor visible (quitamos puntos de miles y cambiamos coma por punto decimal)
            let valorLimpio = costoVis.value.replace(/\./g, '').replace(',', '.');
            let costo = parseFloat(valorLimpio) || 0;
            let recargo = parseFloat(recargoInput.value) || 0;

            let venta = costo + (costo * recargo / 100);

            // Actualizamos los campos visibles (con formato regional para el usuario)
            ventaVis.value = venta.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // IMPORTANTE: Actualizamos los campos ocultos con punto decimal puro para el servidor
            costoReal.value = costo.toFixed(2).replace('.', ','); 
            ventaReal.value = venta.toFixed(2).replace('.', ',');
            
            // Si el servidor sigue fallando con la coma, cambia las dos l√≠neas de arriba por:
            // costoReal.value = costo.toFixed(2);
            // ventaReal.value = venta.toFixed(2);
        }

        costoVis.addEventListener("input", calcular);
        recargoInput.addEventListener("input", calcular);

        // Al enviar el formulario
        document.querySelector('form').addEventListener('submit', function (e) {
            // Nos aseguramos una √∫ltima vez de que los campos reales tengan el dato correcto
            calcular();

            const btn = this.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = '‚è≥ Guardando...';
        });

        function mostrarVistaPrevia(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('imgPreview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
}