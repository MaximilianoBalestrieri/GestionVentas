@{
    ViewData["Title"] = "Proveedores";
}

<h2>Proveedores</h2>

<div id="app">
    <button class="btn btn-success mb-3" v-on:click="nuevo">Agregar Proveedor</button>

    <input type="text" class="form-control mb-3" placeholder="Buscar por nombre o localidad..." v-model="busqueda" />

    <table class="table table-bordered bg-white shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>Teléfono</th>
                <th>Domicilio</th>
                <th>Localidad</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="p in proveedoresFiltrados" :key="p.idProv">
                <td>{{ p.nombre }}</td>
                <td>{{ p.telefono }}</td>
                <td>{{ p.domicilio }}</td>
                <td>{{ p.localidad }}</td>
                <td>
                    <button class="btn btn-warning btn-sm" v-on:click="seleccionar(p)">Editar</button>
                    <button class="btn btn-danger btn-sm" v-on:click="eliminar(p.idProv)">Eliminar</button>
                </td>
            </tr>
            <tr v-if="proveedoresFiltrados.length === 0">
                <td colspan="5" class="text-center">No hay proveedores para mostrar.</td>
            </tr>
        </tbody>
    </table>

    <div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content" v-if="proveedorEditando">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">
                        {{ proveedorEditando.idProv === 0 ? 'Nuevo Proveedor' : 'Editar Proveedor' }}
                    </h5>
                    <button type="button" class="btn-close" v-on:click="cancelar" aria-label="Close"></button>
                </div>
                <form v-on:submit.prevent="guardar">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" v-model="proveedorEditando.nombre" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" v-model="proveedorEditando.telefono" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Domicilio</label>
                            <input type="text" class="form-control" v-model="proveedorEditando.domicilio" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Localidad</label>
                            <input type="text" class="form-control" v-model="proveedorEditando.localidad" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" v-on:click="cancelar">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            {{ proveedorEditando.idProv === 0 ? 'Crear' : 'Actualizar' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                proveedores: [],
                proveedorEditando: null,
                busqueda: '',
                modalBS: null // Referencia para el objeto modal de Bootstrap
            },
            computed: {
                proveedoresFiltrados() {
                    const filtro = this.busqueda.toLowerCase();
                    return this.proveedores.filter(p =>
                        p.nombre.toLowerCase().includes(filtro) ||
                        p.localidad.toLowerCase().includes(filtro)
                    );
                }
            },
            methods: {
                cargar() {
                    fetch('/Proveedores/Obtener')
                        .then(r => r.json())
                        .then(data => this.proveedores = data);
                },
                nuevo() {
                    this.proveedorEditando = { idProv: 0, nombre: '', telefono: '', domicilio: '', localidad: '' };
                    this.abrirModal();
                },
                seleccionar(p) {
                    this.proveedorEditando = Object.assign({}, p);
                    this.abrirModal();
                },
                abrirModal() {
                    if (!this.modalBS) {
                        this.modalBS = new bootstrap.Modal(document.getElementById('modalProveedor'));
                    }
                    this.modalBS.show();
                },
                cancelar() {
                    this.modalBS.hide();
                    this.proveedorEditando = null;
                },
                guardar() {
                    const esNuevo = this.proveedorEditando.idProv === 0;
                    const url = esNuevo ? '/Proveedores/Crear' : '/Proveedores/Editar';
                    
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.proveedorEditando)
                    })
                    .then(() => {
                        this.cargar();
                        this.cancelar(); // Esto cierra el modal
                    });
                },
                eliminar(id) {
                    if (confirm("¿Seguro que querés eliminar este proveedor?")) {
                        fetch('/Proveedores/Eliminar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(id)
                        })
                        .then(() => this.cargar());
                    }
                }
            },
            mounted() {
                this.cargar();
            }
        });
    </script>
}