@{
    ViewBag.Title = "Informe de Ventas por Fecha";
}

<head>
    <style>
        /* Colores personalizados para el <select> */
        .modo-diario { background-color: #f8f9fa; }
        .modo-mensual { background-color: #fff3cd; }
        .modo-anual { background-color: #d1e7dd; }

        .mensaje-error-fechas {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f8d7da;
            color: #842029;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
    </style>
</head>

<div class="container mt-5">
    <div class="card shadow-lg p-4 rounded-4">
        <h2 class="text-center text-primary mb-4">ðŸ“Š Informe de Ventas</h2>

        <form id="formFechas" class="row g-3 align-items-end justify-content-center mb-4">
            <div class="col-auto">
                <label for="fechaDesde" class="form-label fw-bold">Desde:</label>
                <input type="date" id="fechaDesde" name="desde" required class="form-control" />
            </div>
            <div class="col-auto">
                <label for="fechaHasta" class="form-label fw-bold">Hasta:</label>
                <input type="date" id="fechaHasta" name="hasta" required class="form-control" />
            </div>
            <div class="col-auto">
                <label for="modo" class="form-label fw-bold">Agrupar por:</label>
                <select id="modo" name="modo" class="form-select" required>
                    <option value="diario">Diario</option>
                    <option value="mensual">Mensual</option>
                    <option value="anual">Anual</option>
                </select>
            </div>
        </form>

        <div id="mensajeErrorFechas" class="mensaje-error-fechas text-danger small fw-semibold"></div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle text-center w-auto mx-auto" id="tablaVentas">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 150px;">ðŸ—“ Fecha</th>
                        <th style="width: 180px;">ðŸ’µ Total Vendido</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Eventos para recarga automÃ¡tica
    document.getElementById('modo').addEventListener('change', dispararSubmit);
    document.getElementById('fechaDesde').addEventListener('change', dispararSubmit);
    document.getElementById('fechaHasta').addEventListener('change', dispararSubmit);

    function dispararSubmit() {
        const form = document.getElementById('formFechas');
        if (form.checkValidity()) {
            form.dispatchEvent(new Event('submit'));
        }
    }

    const modoSelect = document.getElementById("modo");

    function actualizarColorModo() {
        modoSelect.classList.remove("modo-diario", "modo-mensual", "modo-anual");
        const valor = modoSelect.value;
        if (valor === "diario") modoSelect.classList.add("modo-diario");
        else if (valor === "mensual") modoSelect.classList.add("modo-mensual");
        else if (valor === "anual") modoSelect.classList.add("modo-anual");
    }

    actualizarColorModo();
    modoSelect.addEventListener("change", actualizarColorModo);

    document.getElementById("formFechas").addEventListener("submit", function (e) {
        e.preventDefault();

        const desde = document.getElementById("fechaDesde").value;
        const hasta = document.getElementById("fechaHasta").value;
        const modo = document.getElementById("modo").value;
        const mensajeError = document.getElementById("mensajeErrorFechas");

        if (!desde || !hasta) return;

        mensajeError.style.opacity = "0";

        // Usamos URLSearchParams pero aseguramos que el formato sea el que el controlador espera
        const params = new URLSearchParams();
        params.append("desde", desde);
        params.append("hasta", hasta);
        params.append("modo", modo);

        fetch("/Informes/ObtenerVentasPorFecha", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: params
        })
        .then(async response => {
            if (!response.ok) {
                const textoErr = await response.text();
                throw new Error(textoErr || "Error en el servidor");
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.querySelector("#tablaVentas tbody");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2">No hay datos en ese perÃ­odo.</td></tr>`;
                return;
            }

            let totalGeneral = 0;
            let rowClass = "";
            if (modo === "diario") rowClass = "table-light";
            else if (modo === "mensual") rowClass = "table-warning";
            else if (modo === "anual") rowClass = "table-success";

            data.forEach(item => {
                const fechaRaw = item.fecha || item.Fecha;
                const totalRaw = item.totalVendido || item.TotalVendido;

                const fecha = new Date(fechaRaw).toLocaleDateString('es-AR', { timeZone: 'UTC' });
                const total = parseFloat(totalRaw);
                totalGeneral += total;

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${fecha}</td>
                        <td class="text-end fw-semibold">$ ${total.toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                    </tr>`;
            });

            tbody.innerHTML += `
                <tr class="table-dark fw-bold">
                    <td>Total</td>
                    <td class="text-end">$ ${totalGeneral.toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                </tr>`;
        })
        .catch(error => {
            console.error(error);
            mensajeError.textContent = "âš ï¸ " + error.message;
            mensajeError.style.opacity = "1";
            setTimeout(() => { mensajeError.style.opacity = "0"; }, 5000);
        });
    });
</script>