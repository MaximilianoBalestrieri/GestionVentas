@model List<GestionVentas.Models.Productos>
@{
    ViewBag.Title = "Facturación";
    var fechaHoy = DateTime.Now.ToString("dd/MM/yyyy");
}

<style>
    /* Estilos de tabla y compactación */
    #tablaFactura th, #tablaFactura td { padding: 4px 8px !important; vertical-align: middle; }
    #tablaFactura .cantidad { height: 28px; padding: 2px; margin: 0; }
    .panel-carga-rapida { padding: 12px !important; margin-bottom: 15px !important; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card.p-3 { padding: 15px !important; }
    hr { margin: 10px 0 !important; }
    .row.g-2 { --bs-gutter-y: 0.4rem; }
    h5, h4 { margin-bottom: 8px !important; }
    .is-valid-custom { border-color: #198754 !important; background-color: #e8f5e9 !important; }
    .input-group-text { background-color: #343a40; color: white; border: none; }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="d-flex justify-content-between align-items-center mb-2" style="max-width: 950px; margin: 20px auto 10px auto;">
    <h4 class="mb-0"><i class="bi bi-cart4"></i> Nueva Venta</h4>
</div>

<div id="facturaImprimible" class="card p-4 shadow-sm" style="max-width: 950px; margin: auto; font-size: 14px;">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div class="d-flex align-items-center">
            <img src="/imagenes/logo.png" alt="Logo" style="height: 60px; margin-right: 20px;" onerror="this.style.display='none'">
            <div>
                <h3 style="margin: 0; color: #2c3e50;">Ferretería Santiago</h3>
                <small class="text-muted">La Paz - Córdoba | Tel: 351-XXXXXXX</small>
            </div>
        </div>
        <div class="text-end">
            <h5 class="mb-0">Factura N°: <span id="nroFacturaPrincipal" class="text-danger">0000-0000</span></h5>
            <p class="mb-0 text-muted">Fecha: @fechaHoy</p>
        </div>
    </div>
    
    <hr>

    <div class="mb-3 bg-light p-3 rounded border">
        <div class="row g-3 align-items-center">
            <div class="col-md-2 text-md-end"><strong>DNI / CUIT:</strong></div>
            <div class="col-md-3">
                <input type="text" id="dniCliente" class="form-control form-control-sm" readonly value="00000001">
            </div>
            <div class="col-md-1 text-md-end"><strong>Cliente:</strong></div>
            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <input type="text" id="nombreCliente" class="form-control" readonly value="Consumidor Final">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientesModal">
                        <i class="bi bi-people-fill"></i> Buscar
                    </button>
                </div>
                <input type="hidden" id="idCliente" value="8">
            </div>
        </div>
    </div>

    <div class="row g-2 align-items-end panel-carga-rapida">
        <div class="col-md-3">
            <label class="form-label mb-1 small"><strong>Código de Ptoducto</strong></label>
            <div class="input-group input-group-sm">
             
                <input type="text" id="inputCodigoRapido" class="form-control" placeholder="Ingrese código">
                <button class="btn btn-dark" type="button" data-bs-toggle="modal" data-bs-target="#modalProductos">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label mb-1 small"><strong>Producto Seleccionado</strong></label>
            <input type="text" id="inputNombreRapido" class="form-control form-control-sm" readonly style="background-color: #e9ecef;">
        </div>
        <div class="col-md-1">
            <label class="form-label mb-1 small"><strong>Cant.</strong></label>
            <input type="number" id="inputCantidadRapida" class="form-control form-control-sm text-center" value="1" min="1">
        </div>
        <div class="col-md-2">
            <label class="form-label mb-1 small"><strong>Precio</strong></label>
            <input type="text" id="inputPrecioRapido" class="form-control form-control-sm text-end fw-bold" readonly>
        </div>
        <div class="col-md-2">
            <button type="button" id="btnAgregarRapido" class="btn btn-success btn-sm w-100">
                <i class="bi bi-plus-circle"></i> Agregar
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered border-secondary" id="tablaFactura">
            <thead class="table-dark">
                <tr>
                    <th style="width: 15%;">Código</th>
                    <th>Nombre del Producto</th>
                    <th style="width: 15%;">Precio Unit.</th>
                    <th style="width: 10%;">Cant.</th>
                    <th style="width: 15%;">Subtotal</th>
                    <th style="width: 5%;"></th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div class="row mt-3">
        <div class="col-md-7">
            <div class="alert alert-info py-2 small">
                <i class="bi bi-info-circle"></i> Presione <b>Enter</b> en el código para pasar a cantidad y nuevamente para agregar.
            </div>
        </div>
        <div class="col-md-5 text-end">
            <p class="mb-1"><strong>Subtotal:</strong> <span id="subtotalFactura" class="fs-5">$0.00</span></p>
            <div class="mb-2 d-flex justify-content-end align-items-center">
                <label class="small me-2"><strong>Descuento (%):</strong></label>
                <input type="number" id="descuento" class="form-control form-control-sm text-end" style="width: 80px;" value="0" min="0" max="100">
            </div>
            <h3 class="text-success fw-bold">TOTAL: <span id="totalFactura">$0.00</span></h3>
            
            <div class="mt-4">
                <button class="btn btn-outline-danger me-2" id="btnNuevaFactura" onclick="location.reload()">
                    <i class="bi bi-trash"></i> Cancelar
                </button>
                <button class="btn btn-success btn-lg px-5 shadow" data-bs-toggle="modal" data-bs-target="#modalAbonar">
                    <i class="bi bi-check-all"></i> CONFIRMAR PAGO
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProductos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-box-seam"></i> Listado de Productos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="filtroProductosModal" class="form-control mb-3" placeholder="Buscar por nombre o código...">
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr><th>Código</th><th>Nombre</th><th>Stock</th><th>Precio</th><th>Acción</th></tr>
                        </thead>
                        <tbody id="tablaProductosModal">
                            @foreach (var p in Model) {
                                <tr>
                                    <td>@p.Codigo</td>
                                    <td>@p.Nombre</td>
                                    <td class="@(p.StockActual <= 5 ? "text-danger fw-bold" : "")">@p.StockActual</td>
                                    <td>$@p.PrecioVenta.ToString("F2")</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="seleccionarDesdeModal('@p.IdProducto', '@p.Codigo', '@p.Nombre', @p.PrecioVenta.ToString().Replace(",", "."))">
                                            Seleccionar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-search"></i> Seleccionar Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="filtroCliente" class="form-control mb-3" placeholder="Buscar por nombre o DNI...">
                <div style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead><tr><th>DNI</th><th>Nombre</th><th>Acción</th></tr></thead>
                        <tbody id="tablaClientes">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAbonar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" style="max-width: 420px;">
        <div class="modal-content border-success border-2">
            <div class="modal-header bg-success text-white py-2">
                <h5 class="modal-title w-100 text-center">Cobrar Venta</h5>
            </div>
            <div class="modal-body text-center py-2">
                <h2 class="text-primary mb-2" style="font-size: 2.2rem;">Total: <span id="modalTotal">$0.00</span></h2>

                <p class="small fw-bold mb-1">Medio de Pago:</p>
                <div class="btn-group w-100 mb-3 shadow-sm" role="group">
                    <input type="radio" class="btn-check" name="medioPago" id="rEf" value="Efectivo" checked>
                    <label class="btn btn-outline-success py-2" for="rEf"><i class="bi bi-cash fs-4"></i><br><small>Efectivo</small></label>

                    <input type="radio" class="btn-check" name="medioPago" id="rTr" value="Transferencia">
                    <label class="btn btn-outline-primary py-2" for="rTr"><i class="bi bi-bank fs-4"></i><br><small>Transf.</small></label>

                    <input type="radio" class="btn-check" name="medioPago" id="rCc" value="CtaCte">
                    <label class="btn btn-outline-warning py-2" for="rCc"><i class="bi bi-person-vcard fs-4"></i><br><small>Cta Cte</small></label>
                </div>

                <div id="divVuelto">
                    <div class="form-group mb-2">
                        <label class="small fw-bold">¿Con cuánto paga?</label>
                        <input type="number" class="form-control form-control-sm text-center fw-bold" id="montoAbonado" style="font-size: 1.8rem; color: #198754; height: 50px;">
                    </div>
                    <div class="alert alert-danger py-1 mb-0">
                        <h4 class="mb-0">Vuelto: <span id="vuelto">$0.00</span></h4>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Volver</button>
                <button type="button" class="btn btn-success btn-sm px-4" id="confirmarCompra">
                    <i class="bi bi-printer"></i> CONFIRMAR
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const vendedor = '@ViewBag.nombreyApellido';
    const listaProductosData = @Html.Raw(Json.Serialize(Model));

    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("inputCodigoRapido").focus();
        cargarNroFactura();
        listarClientes(""); // Carga inicial de clientes
    });

    // --- LÓGICA DE CARGA RÁPIDA ---
    const inputCodigo = document.getElementById("inputCodigoRapido");
    const inputNombre = document.getElementById("inputNombreRapido");
    const inputCantidad = document.getElementById("inputCantidadRapida");
    const inputPrecio = document.getElementById("inputPrecioRapido");
    const btnAgregar = document.getElementById("btnAgregarRapido");
    let productoEncontrado = null;

    inputCodigo.addEventListener("keyup", function(e) {
        productoEncontrado = listaProductosData.find(p => p.codigo == this.value.trim());
        if (productoEncontrado) {
            inputNombre.value = productoEncontrado.nombre;
            inputPrecio.value = "$" + parseFloat(productoEncontrado.precioVenta).toFixed(2);
            inputNombre.classList.add("is-valid-custom");
            if (e.key === "Enter") { inputCantidad.focus(); inputCantidad.select(); }
        } else {
            inputNombre.value = ""; inputPrecio.value = ""; inputNombre.classList.remove("is-valid-custom");
        }
    });

    inputCantidad.addEventListener("keypress", (e) => { if(e.key === "Enter") btnAgregar.click(); });

    btnAgregar.addEventListener("click", function() {
        if (!productoEncontrado) return;
        agregarFila(productoEncontrado.idProducto, productoEncontrado.codigo, productoEncontrado.nombre, productoEncontrado.precioVenta, inputCantidad.value);
        inputCodigo.value = ""; inputNombre.value = ""; inputPrecio.value = ""; inputCantidad.value = "1";
        inputCodigo.focus();
    });

    function seleccionarDesdeModal(id, cod, nom, pre) {
        agregarFila(id, cod, nom, pre, 1);
        bootstrap.Modal.getInstance(document.getElementById("modalProductos")).hide();
        inputCodigo.focus();
    }

    function agregarFila(id, cod, nom, pre, cant) {
        let tbody = document.querySelector("#tablaFactura tbody");
        let filaExistente = tbody.querySelector(`tr[data-id="${id}"]`);
        
        if (filaExistente) {
            let input = filaExistente.querySelector(".cantidad");
            input.value = parseInt(input.value) + parseInt(cant);
            recalcularFila(input);
        } else {
            let tr = document.createElement("tr");
            tr.setAttribute("data-id", id);
            tr.innerHTML = `
                <td class="small fw-bold">${cod}</td>
                <td>${nom}</td>
                <td class="pre text-end">$${parseFloat(pre).toFixed(2)}</td>
                <td><input type="number" class="form-control form-control-sm text-center cantidad" value="${cant}" oninput="recalcularFila(this)" min="1"></td>
                <td class="sub text-end fw-bold">$${(pre * cant).toFixed(2)}</td>
                <td class="text-center"><button class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); actualizarTotales();"><i class="bi bi-x-lg"></i></button></td>`;
            tbody.appendChild(tr);
        }
        actualizarTotales();
    }

    function recalcularFila(input) {
        let tr = input.closest("tr");
        let precio = parseFloat(tr.querySelector(".pre").innerText.replace("$", ""));
        tr.querySelector(".sub").innerText = "$" + (precio * input.value).toFixed(2);
        actualizarTotales();
    }

    function actualizarTotales() {
        let sub = 0;
        document.querySelectorAll(".sub").forEach(td => sub += parseFloat(td.innerText.replace("$", "")));
        let desc = parseFloat(document.getElementById("descuento").value) || 0;
        let total = sub - (sub * (desc / 100));
        document.getElementById("subtotalFactura").innerText = "$" + sub.toFixed(2);
        document.getElementById("totalFactura").innerText = "$" + total.toFixed(2);
        document.getElementById("modalTotal").innerText = "$" + total.toFixed(2);
    }

    // --- COBRO Y VUELTO ---
    document.getElementById("modalAbonar").addEventListener("shown.bs.modal", function() {
        document.getElementById("montoAbonado").value = "";
        document.getElementById("vuelto").innerText = "$0.00";
        document.getElementById("montoAbonado").focus();
    });

    document.getElementById("montoAbonado").addEventListener("input", function() {
        let total = parseFloat(document.getElementById("totalFactura").innerText.replace("$", ""));
        let pago = parseFloat(this.value) || 0;
        let res = pago - total;
        document.getElementById("vuelto").innerText = "$" + (res < 0 ? "0.00" : res.toFixed(2));
    });

    document.querySelectorAll('input[name="medioPago"]').forEach(r => {
        r.addEventListener("change", function() {
            document.getElementById("divVuelto").style.opacity = (this.value === "CtaCte") ? "0.3" : "1";
            if(this.value === "CtaCte" && document.getElementById("idCliente").value === "8") {
                alert("⚠️ Debe seleccionar un cliente de la lista para vender a Cuenta Corriente (Fiado).");
                document.getElementById("rEf").checked = true;
                document.getElementById("divVuelto").style.opacity = "1";
            }
        });
    });

    // --- REGISTRO FINAL (AQUÍ CORREGIMOS EL NOMBREPROD) ---
    document.getElementById("confirmarCompra").addEventListener("click", function() {
        const idCliente = document.getElementById("idCliente").value;
        const medio = document.querySelector('input[name="medioPago"]:checked').value;
        const totalVenta = document.getElementById("totalFactura").innerText.replace("$", "").replace(",", ".");
        
        const productos = [];
        document.querySelectorAll("#tablaFactura tbody tr").forEach(tr => {
            productos.push({ 
                IdProducto: tr.dataset.id, 
                Cantidad: tr.querySelector(".cantidad").value, 
                Precio: tr.querySelector(".pre").innerText.replace("$", "").replace(",", "."),
                NombreProd: tr.cells[1].innerText // <--- SOLUCIÓN AL ERROR DE SQL
            });
        });

        if(productos.length === 0) return alert("❌ Cargue productos para la venta.");

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

        fetch("/Ventas/RegistrarVenta", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                IdCliente: idCliente,
                MontoVenta: totalVenta,
                Vendedor: vendedor,
                MedioPago: medio,
                TipoVenta: (medio === "CtaCte" ? "Cuenta Corriente" : "Contado"),
                Items: productos
            })
        }).then(r => r.json()).then(data => {
            if(data.success) {
                alert("✅ ¡Venta registrada correctamente!");
                location.reload();
            } else {
                alert("❌ Error: " + data.message);
                this.disabled = false;
                this.innerText = "CONFIRMAR Y FINALIZAR";
            }
        });
    });

    // --- FILTROS Y CLIENTES ---
    document.getElementById("filtroCliente").addEventListener("input", function() {
        listarClientes(this.value);
    });

    function listarClientes(filtro) {
        fetch("/Clientes/BuscarClientes?filtro=" + filtro)
        .then(r => r.json())
        .then(data => {
            let html = "";
            data.forEach(c => {
                html += `<tr>
                    <td>${c.dniCliente || '---'}</td>
                    <td>${c.nombreCliente}</td>
                    <td><button class="btn btn-success btn-sm" onclick="seleccionarCli(${c.idCliente}, '${c.nombreCliente}', '${c.dniCliente || ''}')">Ok</button></td>
                </tr>`;
            });
            document.getElementById("tablaClientes").innerHTML = html;
        });
    }

    function seleccionarCli(id, nom, dni) {
        document.getElementById("idCliente").value = id;
        document.getElementById("nombreCliente").value = nom;
        document.getElementById("dniCliente").value = dni;
        bootstrap.Modal.getInstance(document.getElementById("clientesModal")).hide();
    }

    document.getElementById("filtroProductosModal").addEventListener("input", function() {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#tablaProductosModal tr").forEach(tr => {
            tr.style.display = tr.innerText.toLowerCase().includes(filtro) ? "" : "none";
        });
    });

    function cargarNroFactura() {
        fetch('/Ventas/ObtenerProximoNroFactura').then(r => r.json()).then(d => { 
            document.getElementById("nroFacturaPrincipal").textContent = d.nroFactura; 
        });
    }
</script>
}