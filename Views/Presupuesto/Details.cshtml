@model Presupuesto

@{
    ViewBag.Title = "Detalle del Presupuesto";
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<head>
    <link rel="stylesheet" href="/css/presupuesto.css" />
</head>

<h2 class="mb-4">üìÑ Detalle del Presupuesto</h2>

<div id="facturaImprimible" class="card p-3 shadow-sm" style="max-width: 900px; margin: auto; font-size: 14px;">
    <div class="presupuesto-box">
        <!-- ENCABEZADO CON LOGO -->
        <div class="presupuesto-header d-flex align-items-center mb-4 border-bottom pb-3">
            <img src="/imagenes/logo.png" alt="Logo" style="width: 80px; height: auto; margin-right: 15px;" />
            <div>
                <h2 class="fw-bold mb-0">Ferreter√≠a Santiago</h2>
                <p class="text-muted mb-0">üìç La Paz, C√≥rdoba</p>
            </div>
        </div>

        <!-- INFO GENERAL -->
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>Nro. Presupuesto:</strong> @Model.IdPresupuesto
            </div>
            <div class="col-md-6 text-end">
                <strong>Fecha:</strong> @Model.Fecha.ToShortDateString()
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <strong>Cliente:</strong> @Model.NombreCliente
            </div>
            <div class="col-md-6 text-end">
                <strong>Tel√©fono:</strong> @Model.TelefonoCliente
            </div>
        </div>

        <hr style="border-top: 1px solid #999; margin: 20px 0;" />

        <!-- PRODUCTOS -->
        <table class="table table-bordered mt-3">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-end">Precio Unitario</th>
                    <th class="text-end">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items ?? Enumerable.Empty<PresupuestoItem>())
                {
                    <tr>
                        <td>@item.Nombre</td>
                        <td class="text-center">@item.Cantidad</td>
                        <td class="text-end">$@item.PrecioUnitario.ToString("N2")</td>
                        <td class="text-end">$@item.Subtotal.ToString("N2")</td>
                    </tr>
                }
                <tr class="fw-bold table-dark">
                    <td colspan="3" class="text-end">Total</td>
                    <td class="text-end">
                        $@Model.Items.Sum(p => p.Subtotal).ToString("N2")
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="text-end mt-4 d-print-none">
   <button onclick="imprimirLindo()" class="btn btn-primary">Imprimir</button>
<button onclick="enviarPorWhatsApp()" class="btn btn-success">Enviar x WhatsApp</button>
    
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Volver</a>
</div>

<style>
    @@media print {
        .d-print-none { display: none !important; }
    }
    /* Estabiliza el renderizado del PDF */
    #facturaImprimible {
        background-color: white !important;
        padding: 15px !important;
    }
    .table {
        width: 100% !important;
        border-collapse: collapse !important;
    }
</style>
<script>
    // 1. Funci√≥n unificada con par√°metro de "margen extra"
    function generarHTMLPresupuesto(conEspacioExtra = false) {
        const nro = "@Model.IdPresupuesto";
        const cliente = "@Model.NombreCliente";
        const telefono = "@Model.TelefonoCliente";
        const totalCalculado = "@Model.Items.Sum(p => p.Subtotal).ToString("N2")";

        let html = `
            <div style="font-family: Arial, sans-serif; padding: 20px 40px; color: #000; background-color: white;">
                <div style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="margin:0; font-size: 28px;">Ferreter√≠a Santiago</h1>
                    <p style="margin:0; font-size: 14px;">üìç La Paz, C√≥rdoba</p>
                </div>
                <table style="width: 100%; margin-bottom: 20px; font-size: 14px;">
                    <tr>
                        <td style="width: 50%;"><strong>Presupuesto Nro:</strong> ${nro}</td>
                        <td style="text-align: right; width: 50%;"><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</td>
                    </tr>
                    <tr>
                        <td><strong>Cliente:</strong> ${cliente}</td>
                        <td><strong>Tel√©fono:</strong> ${telefono}</td>
                    </tr>
                </table>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px;" border="1">
                    <thead style="background-color: #f2f2f2;">
                        <tr>
                            <th style="padding: 10px; text-align: left;">Producto</th>
                            <th style="padding: 10px; text-align: center; width: 60px;">Cant.</th>
                            <th style="padding: 10px; text-align: right; width: 100px;">Precio Unit.</th>
                            <th style="padding: 10px; text-align: right; width: 100px;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        const items = [
            @foreach (var item in Model.Items) {
                <text>{ nombre: "@item.Nombre", cant: "@item.Cantidad", precio: "@item.PrecioUnitario.ToString("N2")", sub: "@item.Subtotal.ToString("N2")" },</text>
            }
        ];

        items.forEach(item => {
            html += `
                <tr>
                    <td style="padding: 8px;">${item.nombre}</td>
                    <td style="padding: 8px; text-align: center;">${item.cant}</td>
                    <td style="padding: 8px; text-align: right;">$${item.precio}</td>
                    <td style="padding: 8px; text-align: right;">$${item.sub}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                    <tfoot>
                        <tr style="background-color: #333; color: #fff;">
                            <td colspan="3" style="padding: 12px; text-align: right; font-weight: bold; font-size: 15px;">TOTAL</td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; font-size: 15px;">$${totalCalculado}</td>
                        </tr>
                    </tfoot>
                </table>
                <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #555;">
                    <p>Este presupuesto   tiene una validez de 15 d√≠as.</p>
                    <p><strong>Gracias por elegirnos.</strong></p>
                </div>
                ${conEspacioExtra ? '<div style="height: 60px;"></div>' : ''}
            </div>
        `;
        return html;
    }

    // 2. Imprimir (Sin espacio extra para no gastar hoja)
    function imprimirLindo() {
        const contenido = generarHTMLPresupuesto(false);
        const ventana = window.open('', '_blank');
        ventana.document.write('<html><head><title>Imprimir</title></head><body>' + contenido + '</body></html>');
        ventana.document.close();
        setTimeout(() => { ventana.print(); ventana.close(); }, 500);
    }

    // 3. WhatsApp (CON espacio extra para que no corte el TOTAL)
    function enviarPorWhatsApp() {
        const nro = "@Model.IdPresupuesto";
        const cliente = "@Model.NombreCliente";
        const telefono = "@Model.TelefonoCliente";
        const totalCalculado = "@Model.Items.Sum(p => p.Subtotal).ToString("N2")";

        if (!telefono || telefono.trim() === "") {
            alert("El cliente no tiene tel√©fono.");
            return;
        }

        // Pasamos 'true' para agregar el margen de seguridad abajo
        const contenido = generarHTMLPresupuesto(true);
        
        const opciones = {
            margin: [10, 5, 10, 5],
            filename: 'Presupuesto_' + nro + '.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().from(contenido).set(opciones).save().then(() => {
            const telLimpio = telefono.replace(/\D/g, '');
            const texto = `Hola *${cliente}*!\nTe env√≠o el presupuesto solicitado de *Ferreter√≠a Santiago*.\n\nNro: ${nro}\nTotal: $${totalCalculado}`;
            window.open(`https://wa.me/${telLimpio}?text=${encodeURIComponent(texto)}`, '_blank');
        });
    }
</script>
