@model IEnumerable<GestionVentas.Models.MovimientoCtaCte>
@{
    ViewData["Title"] = "Libreta de Cuenta Corriente";
}

<div class="container mt-4">
    @* --- ENCABEZADO --- *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Libreta: <span class="text-primary">@ViewBag.NombreCliente</span></h2>
            <p class="text-muted">Gestión de Cuenta Corriente (Presione <b>F2</b> para buscar)</p>
        </div>
        <div class="btn-group">
            <button onclick="imprimirEstadoCuenta()" class="btn btn-dark">
                <i class="bi bi-printer"></i> Imprimir Estado
            </button>
            <a href="@Url.Action("Index", "ClientesCtaCte")" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left-circle"></i> Volver a Clientes
            </a>
        </div>
    </div>

    @* --- CARGA RÁPIDA --- *@
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Código</label>
                    <div class="input-group">
                        <input type="text" id="txtCodigo" class="form-control border-primary" 
                               placeholder="000" oninput="buscarAutomatico(this.value)">
                        <button class="btn btn-dark" onclick="abrirModalProductos()"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold">Producto</label>
                    <input type="text" id="txtNombreProd" class="form-control" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="col-md-1">
                    <label class="form-label small fw-bold">Cant.</label>
                    <input type="number" id="txtCant" class="form-control" value="1" min="1" 
                           onkeydown="if(event.key === 'Enter') agregarATablaTemporal()">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold">Precio</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="text" id="txtPrecio" class="form-control fw-bold" readonly>
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100 fw-bold" onclick="agregarATablaTemporal()">
                        <i class="bi bi-plus-circle"></i> Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* --- GRILLA TEMPORAL --- *@
    <div class="card shadow-sm mb-4 border-primary" id="cardTemporal" style="display:none;">
        <div class="card-header bg-primary text-white py-1">Nuevos ítems a cargar</div>
        <div class="card-body p-0">
            <form asp-action="GuardarVentaCtaCte" method="post">
                <input type="hidden" name="idCliente" value="@ViewBag.IdCliente" />
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th class="text-end">Precio</th>
                            <th style="width: 80px;">Cant.</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTemporal"></tbody>
                </table>
                <div class="p-3 bg-white text-end border-top">
                    <h3 class="text-success fw-bold">A DEUDAR: $<span id="lblTotalTemporal">0.00</span></h3>
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        <i class="bi bi-save"></i> REGISTRAR EN LIBRETA
                    </button>
                </div>
            </form>
        </div>
    </div>

    @* --- HISTORIAL --- *@
    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white p-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Movimientos de Cuenta</h5>
            <div class="text-end">
                <small class="d-block text-uppercase">Saldo Adeudado Actual</small>
                <span class="fs-4 fw-bold text-warning">$@ViewBag.TotalDeuda.ToString("N2")</span>
            </div>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0" id="tablaHistorial">
                <thead class="table-secondary">
                    <tr>
                        <th class="ps-3">Fecha</th>
                        <th>Concepto / Detalle</th>
                        <th class="text-end">Importe</th>
                        <th class="text-end pe-3">Saldo</th>
                    </tr>
                </thead>
               <tbody>
    @foreach (var item in Model) {
        <tr>
            <td class="ps-3">@item.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
            <td class="small">@item.Concepto</td>
            
            @if (item.Monto < 0) {
                @* Si el monto es negativo, es un PAGO (VERDE) *@
                <td class="text-end text-success fw-bold">
                    -$@Math.Abs(item.Monto).ToString("N2")
                </td>
            } else {
                @* Si el monto es positivo, es una DEUDA (ROJO) *@
                <td class="text-end text-danger fw-bold">
                    $@item.Monto.ToString("N2")
                </td>
            }

            <td class="text-end pe-3 text-muted">$@item.SaldoResultante.ToString("N2")</td>
        </tr>
    }
</tbody>
            </table>
        </div>
    </div>
</div>

@* --- MODAL DE PRODUCTOS CON COLUMNA STOCK --- *@
<div class="modal fade" id="modalProductos" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Buscar Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                        <input type="text" id="buscarProductoModal" class="form-control" 
                               placeholder="Escribí nombre o código..." 
                               onkeyup="filtrarProductosModal()">
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm" id="tablaProductosModal">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th class="text-center">Stock</th>
                                <th>Precio</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewBag.ListaProductos != null) {
                                foreach (var p in ViewBag.ListaProductos) {
                                    // Definimos un color para el stock: rojo si es 0, naranja si es poco, verde si hay.
                                    string stockColor = p.StockActual <= 0 ? "text-danger fw-bold" : (p.StockActual < 5 ? "text-warning fw-bold" : "text-success");
                                    <tr>
                                        <td>@p.Codigo</td>
                                        <td>@p.Nombre</td>
                                        <td class="text-center @stockColor">@p.StockActual</td>
                                        <td>$@p.PrecioVenta.ToString("N2")</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    onclick="seleccionarDesdeModal('@p.IdProducto', '@p.Codigo', '@p.Nombre', @p.PrecioVenta.ToString().Replace(',','.'), @p.StockActual)">
                                                Seleccionar
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let prodSeleccionado = null;
        let timerBusqueda;

        document.addEventListener('keydown', function(e) {
            if (e.key === "F2") { e.preventDefault(); abrirModalProductos(); }
        });

        function filtrarProductosModal() {
            let filter = document.getElementById("buscarProductoModal").value.toLowerCase();
            let trs = document.querySelectorAll("#tablaProductosModal tbody tr");
            trs.forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(filter) ? "" : "none";
            });
        }

        function buscarAutomatico(codigo) {
            clearTimeout(timerBusqueda);
            if (codigo.length < 2) return;
            timerBusqueda = setTimeout(() => {
                fetch(`/CtaCte/BuscarProductoPorCodigo?codigo=${codigo}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Suponiendo que tu API de búsqueda también devuelve 'stock'
                            seleccionarProducto(data.id, codigo, data.nombre, data.precio, data.stock);
                        }
                    });
            }, 300);
        }

        function seleccionarProducto(id, cod, nom, precio, stock) {
            prodSeleccionado = { id, cod, nom, precio, stock };
            document.getElementById('txtCodigo').value = cod;
            document.getElementById('txtNombreProd').value = nom + " (Stock: " + stock + ")";
            document.getElementById('txtPrecio').value = precio.toFixed(2);
            
            // Si no hay stock, avisar visualmente
            if(stock <= 0) {
                document.getElementById('txtNombreProd').classList.add('is-invalid');
            } else {
                document.getElementById('txtNombreProd').classList.remove('is-invalid');
            }

            document.getElementById('txtCant').focus();
            document.getElementById('txtCant').select();
        }

        function seleccionarDesdeModal(id, cod, nom, precio, stock) {
            seleccionarProducto(id, cod, nom, precio, stock);
            bootstrap.Modal.getInstance(document.getElementById('modalProductos')).hide();
        }

        function agregarATablaTemporal() {
            if (!prodSeleccionado) return;
            
            let cant = parseFloat(document.getElementById('txtCant').value);
            
            // VALIDACIÓN DE STOCK
            if (cant > prodSeleccionado.stock) {
                if (!confirm(`Ojo: Solo tenés ${prodSeleccionado.stock} en stock. ¿Querés cargar ${cant} de todas formas?`)) {
                    return;
                }
            }

            document.getElementById('cardTemporal').style.display = 'block';
            let subtotal = prodSeleccionado.precio * cant;

            let fila = `
                <tr>
                    <td><input type="hidden" name="ids" value="${prodSeleccionado.id}">${prodSeleccionado.cod}</td>
                    <td>${prodSeleccionado.nom}</td>
                    <td class="text-end precio-unitario">$${prodSeleccionado.precio.toFixed(2)}</td>
                    <td><input type="number" name="cants" class="form-control form-control-sm input-cantidad" value="${cant}" oninput="recalcular()"></td>
                    <td class="text-end fw-bold sub"> $${subtotal.toFixed(2)} </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); recalcular();">X</button>
                    </td>
                </tr>`;
            
            document.getElementById('cuerpoTemporal').innerHTML += fila;
            recalcular();
            
            prodSeleccionado = null;
            document.getElementById('txtCodigo').value = "";
            document.getElementById('txtNombreProd').value = "";
            document.getElementById('txtNombreProd').classList.remove('is-invalid');
            document.getElementById('txtPrecio').value = "";
            document.getElementById('txtCant').value = 1;
            document.getElementById('txtCodigo').focus();
        }

        function recalcular() {
            let total = 0;
            document.querySelectorAll("#cuerpoTemporal tr").forEach(tr => {
                let p = parseFloat(tr.querySelector('.precio-unitario').innerText.replace('$', '').trim());
                let c = parseFloat(tr.querySelector('.input-cantidad').value) || 0;
                let sub = p * c;
                tr.querySelector('.sub').innerText = "$" + sub.toFixed(2);
                total += sub;
            });
            document.getElementById('lblTotalTemporal').innerText = total.toFixed(2);
            if(total <= 0 && document.querySelectorAll("#cuerpoTemporal tr").length === 0) 
                document.getElementById('cardTemporal').style.display = 'none';
        }

        function abrirModalProductos() {
            let myModal = new bootstrap.Modal(document.getElementById('modalProductos'));
            myModal.show();
            setTimeout(() => document.getElementById('buscarProductoModal').focus(), 500);
        }
        // --- FUNCIÓN DE IMPRESIÓN CORREGIDA ---
        function imprimirEstadoCuenta() {
            const nombre = "@ViewBag.NombreCliente";
            const saldo = "@ViewBag.TotalDeuda.ToString("N2")";
            const filas = document.querySelectorAll("#tablaHistorial tbody tr");
            
            let contenido = `<html><head><title>Estado de Cuenta</title>
                <style>
                    body { font-family: 'Courier New', monospace; font-size: 12px; padding: 20px; }
                    .text-center { text-align: center; }
                    .text-end { text-align: right; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    th, td { border-bottom: 1px solid #ddd; padding: 5px; }
                    .total { font-size: 16px; font-weight: bold; margin-top: 20px; border-top: 2px solid #000; padding-top: 10px; }
                </style></head><body>
                <div class="text-center"><h3>MI FERRETERÍA</h3><p>Resumen de Cuenta Corriente</p></div>
                <p><strong>Cliente:</strong> ${nombre}<br><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
                <hr><table><thead><tr><th>Fecha</th><th>Concepto</th><th class="text-end">Monto</th></tr></thead><tbody>`;

            filas.forEach(fila => {
                const celdas = fila.querySelectorAll("td");
                if (celdas.length >= 3) {
                    contenido += `<tr><td>${celdas[0].innerText}</td><td>${celdas[1].innerText}</td><td class="text-end">${celdas[2].innerText}</td></tr>`;
                }
            });

            contenido += `</tbody></table>
                <div class="text-end total">SALDO TOTAL DEUDOR: $${saldo}</div>
                <p class="text-center"><br>*** Gracias por su confianza ***</p>
                <script>window.onload = function() { window.print(); window.close(); };<\/script>
                </body></html>`;

            const ventana = window.open('', '_blank');
            ventana.document.write(contenido);
            ventana.document.close();
        }
    </script>
}